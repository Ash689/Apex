<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor | Booking</title>
    <link rel="stylesheet" href="/static/viewBookings.css">
    <link rel="stylesheet" href="/static/standardStyle.css">
</head>
<body>
    <div id="navbarTutor"></div>
    <div id="message" class="message"></div>
    <br><br><br><br><br>
    <div class="container">
        <table id="bookingsTable">
            <br><br><br><br><br>
            <h2>Bookings</h2>
            <form action="/tutor/viewBooking.html" method="GET">
                <button class="secondary-button" type="submit">View Upcoming Bookings</button>
            </form>
            <tbody id="bookings"></tbody>
        </table>
        <br><br><br><br><br><br><br><br><br><br>
    </div>
    <div id="footer" class="footer"></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/script/standardScript.js"></script>
    <script src="/script/tutorScript.js"></script>
    <script src="/script/bookingButtons.js"></script>
    <script src="/script/bookingDateFormat.js"></script>
    <script>
        const bookingTableBody = document.getElementById('bookings');

        fetch('/viewOldBookings')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                messageElement.textContent = data.error;
                messageElement.classList.add('error');
            } else {
                const bookings = data.bookings;
                if (bookings.length === 0) {
                    bookingTableBody.innerHTML = '<tr><td colspan="6">No bookings found.</td></tr>';
                } else {
                    // Group bookings by date
                    let groupedBookings = {};
                    bookings.forEach(booking => {
                        const date = new Date(booking.date);
                        const dateString = date.toISOString().split('T')[0]; // Get the date part in YYYY-MM-DD format
                        if (!groupedBookings[dateString]) {
                            groupedBookings[dateString] = [];
                        }
                        groupedBookings[dateString].push(booking);
                    });

                    // Render grouped bookings
                    Object.keys(groupedBookings).forEach(date => {
                        const formattedDate = formatDate(date);
                        const dateRow = document.createElement('tr');
                        dateRow.innerHTML = `<td colspan="6" style="font-weight: bold; background-color: #efefef;">${formattedDate}</td>`;
                        bookingTableBody.appendChild(dateRow);

                        groupedBookings[date].forEach(booking => {
                            const row = document.createElement('tr');
                            const profileImage = booking.student.filename ? `/uploads/profileFiles/student/profilePicture/${booking.student.filename}` : '../images/P1.jpg';
                            const disableLaunchButton = shouldDisableLaunchButton(booking.date, booking.time, booking.duration);

                            row.innerHTML = `
                                <td>                                    
                                    <img style = "width:200px" src="${profileImage}" alt="Profile Image">
                                    <form action="/getBookingID2" method="POST">
                                        <input type="hidden" name="bookingId" value="${booking._id}">
                                        <a href="#" onclick="this.closest('form').submit();" style="font-style: italic; text-decoration: none;">${booking.studentName}</a>
                                    </form>
                                </td>
                                <td>${booking.time}</td>
                                <td> Duration: <br> ${booking.duration}minutes</td>
                                <td>${booking.subject}</td>
                                ${!booking.revisionSession ? `
                                    <td>${booking.plan}</td>
                                ` : '<td>Revision Session</td>'}
                                ${!booking.notes ? `
                                    <td>
                                        <form action="/tutor/launchReport" method="POST">
                                            <input type="hidden" name="bookingId" value="${booking._id}">
                                            <button type="submit" class="secondary-button">Create Lesson Notes</button>
                                        </form>
                                    </td>
                                ` : '<td>Lesson Complete</td>'}
                            `;
                            bookingTableBody.appendChild(row);
                        });
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error fetching bookings:', error);
            messageElement.textContent = 'Failed to show bookings';
            messageElement.classList.add('error');
        });

    </script>
</body>
</html>
