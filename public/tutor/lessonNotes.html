<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor | Report</title>
    <link rel="stylesheet" href="/static/lessonReport.css">
    <link rel="stylesheet" href="/static/standardStyle.css">
</head>
<body>
    <div id="navbarTutor"></div>
    <div id="message" class="message"></div>
    <br><br><br><br><br>
    <div class="container">
        <div id="student-profile" class="profile-bar"></div>
        <br><br>
        <form id="lessonNoteForm" action="/tutor/lessonNotesSubmit" method="post">
            <h2>Lesson Notes</h2>

            <!-- Main Table -->
            <table id="lessonTable">
                <tbody id="lessonTableBody">
                    <tr class="topicRow">
                        <td>Topic
                            <span id = "info-button" class="info-button">ℹ️</span>
                        </td>
                        <td>
                            <div class="autocomplete-container">
                                <input name="topics" class="notesContainerInput" autocomplete="off">
                                <div class="autocomplete-suggestions"></div>    
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3"><button class="secondary-button" type="button" id="notesContainerBtn">Add Another Topic</button></td>
                    </tr>
                    <tr>
                        <td colspan = "2">
                            <button id = "submitBtn" type="submit">Submit</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </form>
    </div>
    <br><br><br><br><br>
    <div id="footer" class="footer"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="/script/standardScript.js"></script>
    <script src="/script/tutor/script.js"></script>
    <script src="/script/bookingReportScript.js"></script>
    <script src = "/script/topicList.js"></script>
    <script>

        function handleInput(e) {
            const inputField = e.target;
            const inputValue = inputField.value.toLowerCase();
            const suggestionsContainer = inputField.nextElementSibling;
            suggestionsContainer.innerHTML = '';

            if (inputValue) {
                const filteredTopics = topics.filter(topic => topic.toLowerCase().includes(inputValue));
                filteredTopics.forEach((topic, index) => {
                    const suggestionElement = document.createElement('div');
                    suggestionElement.classList.add('autocomplete-suggestion');
                    suggestionElement.textContent = topic;
                    suggestionElement.dataset.index = index; // Store index for navigation
                    suggestionElement.addEventListener('click', function() {
                        inputField.value = topic;
                        suggestionsContainer.innerHTML = '';
                    });
                    suggestionsContainer.appendChild(suggestionElement);
                });
                suggestionsContainer.style.display = filteredTopics.length ? 'block' : 'none';
            } else {
                suggestionsContainer.style.display = 'none';
            }


            // Handle keyboard navigation
            inputField.dataset.activeIndex = -1;
        }

        function handleKeydown(e) {
            const inputField = e.target;
            const suggestionsContainer = inputField.nextElementSibling;
            const suggestions = Array.from(suggestionsContainer.children);
            const activeIndex = parseInt(inputField.dataset.activeIndex, 10);

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (activeIndex < suggestions.length - 1) {
                    inputField.dataset.activeIndex = activeIndex + 1;
                    updateSuggestionFocus(suggestions, activeIndex + 1);
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (activeIndex > 0) {
                    inputField.dataset.activeIndex = activeIndex - 1;
                    updateSuggestionFocus(suggestions, activeIndex - 1);
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (activeIndex >= 0 && activeIndex < suggestions.length) {
                    const selectedSuggestion = suggestions[activeIndex];
                    inputField.value = selectedSuggestion.textContent;
                    suggestionsContainer.innerHTML = '';
                }
            }
        }

        function updateSuggestionFocus(suggestions, index) {
            suggestions.forEach((suggestion, i) => {
                suggestion.classList.toggle('selected', i === index);
            });
        }

        function handleClickOutside(e) {
            if (!e.target.matches('.notesContainerInput')) {
                document.querySelectorAll('.autocomplete-suggestions').forEach(container => container.style.display = 'none');
            }
        }

        document.querySelectorAll('.notesContainerInput').forEach(input => {
            input.addEventListener('input', handleInput);
            input.addEventListener('keydown', handleKeydown);
        });

        document.getElementById('notesContainerBtn').addEventListener('click', function() {
            const newTopicRow = document.createElement('tr');
            newTopicRow.className = 'topicRow';
            newTopicRow.innerHTML = `
                <td>Topic</td>
                <td>
                    <div class="autocomplete-container">
                        <input name="topics" class="notesContainerInput" autocomplete="off">
                        <div class="autocomplete-suggestions"></div>
                    </div>
                </td>
            `;
            document.getElementById('lessonTableBody').insertBefore(newTopicRow, this.closest('tr'));

            // Rebind events for new inputs
            bindAutocompleteToNewInputs();
        });

        function bindAutocompleteToNewInputs() {
            document.querySelectorAll('.notesContainerInput').forEach(input => {
                input.addEventListener('input', handleInput);
                input.addEventListener('keydown', handleKeydown);
            });
        }

        document.addEventListener('click', handleClickOutside);
        bindAutocompleteToNewInputs();

        
        document.getElementById('info-button').title = "Write each topic and add them to the list." + "\n" + "This will be separated in the Lesson Report section next.";

    </script>
</body>
</html>
